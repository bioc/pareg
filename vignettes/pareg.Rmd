---
title: "Get started"
author: "Kim Philipp Jablonski"
date: "`r Sys.Date()`"
graphics: yes
output: BiocStyle::html_document
bibliography: bibliography.bib
vignette: >
    %\VignetteIndexEntry{Get started}
    %\VignetteEngine{knitr::rmarkdown}
    %\VignetteEncoding{UTF-8}
---

# Overview

Pathway enrichment.

# Installation

```{r eval=FALSE}
if (!require("BiocManager", quietly = TRUE))
    install.packages("BiocManager")
BiocManager::install("pareg")
```

# Load required packages

Load `pareg` package and other required libraries.

```{r message=FALSE}
library(ggraph)
library(tidyverse)

library(pareg)

set.seed(42)
```

# Introductory example

## Retrieve pathway database

We start by constructing a dataframe containing pathway information.

```{r}
term_list <- list(
  hub_1 = paste0("g", 1:100),
  hub_2 = paste0("g", 71:170)
)

generate_term <- function(main_nodes, other_node_marker, term_count) {
  function(x) {
    other_nodes <- paste0(x, other_node_marker, 1:100)

    term_size <- 50 + sample.int(20, 1) - 10 # random int in (40, 60]
    c(
      sample(main_nodes, round(x / term_count * term_size)),
      sample(other_nodes, round((1 - x / term_count) * term_size))
    )
  }
}

term_count <- 5
term_list <- c(
  term_list,
  set_names(seq_len(term_count), paste0("t1_", seq_len(term_count))) %>%
    purrr::map(generate_term(term_list$hub_1, "_tg1_", term_count)),
  set_names(seq_len(term_count), paste0("t2_", seq_len(term_count))) %>%
    purrr::map(generate_term(term_list$hub_2, "_tg2_", term_count))
)

df_terms <- term_list %>%
  enframe("term", "gene") %>%
  unnest_longer(gene)

df_terms %>%
  group_by(term) %>%
  summarize(size = n()) %>%
  arrange(desc(size)) %>%
  head %>%
  knitr::kable()
```

## Create synthetic study

We then select a subset of genes to serve as the differentially expressed genes of our synthetic study.

```{r}
active_terms <- c("hub_1", "hub_2")

de_genes <- df_terms %>%
  filter(term %in% active_terms) %>%
  distinct(gene) %>%
  pull(gene)

other_genes <- df_terms %>%
  distinct(gene) %>%
  pull(gene) %>%
  setdiff(de_genes)
```

For these genes, we can generate artificial p-values.

```{r}
df_study <- data.frame(
  gene = c(de_genes, other_genes),
  pvalue = c(rbeta(length(de_genes), 0.1, 1), rbeta(length(other_genes), 1, 1)),
  in_study = c(
    rep(TRUE, length(de_genes)),
    rep(FALSE, length(other_genes))
  )
)

table(df_study$pvalue <= 0.05, df_study$in_study, dnn = c("sig. p-value", "in study"))
```

## Enrichment analysis

We start the pathway enrichment analysis by computing term similarities with `pareg`'s helper functions.

```{r}
term_network <- compute_term_similarities(df_terms)

hist(term_network, xlab = "Term similarity")
```

We can then compute our pathway enrichment values.

```{r}
fit <- pareg(df_study %>% select(-in_study), df_terms, network_param = 1, term_network = term_network)

fit %>%
  as.data.frame %>%
  arrange(desc(abs(enrichment))) %>%
  head %>%
  knitr::kable()
```

And finally, we can visualize the obtained results.

```{r}
plot(fit, min_similarity = 0.1)
```
